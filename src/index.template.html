<script>
  const amount = document.querySelector("#amount");
  const fromCurrency = document.querySelector("#fromCurrency");
  const toCurrency = document.querySelector("#toCurrency");
  const swapCurrencies = document.querySelector("#swapCurrencies");

  const allCurrencies = {"EUR": 1, "USD": 2, "BYN": 3};
  const specialCurrencies = ["AED", "THB", "EUR", "BYN", "USD"];
  getCurrencies(allCurrencies, specialCurrencies)
    .forEach(currency => {
      const optionFrom = document.createElement("option");
      optionFrom.value = allCurrencies[currency];
      optionFrom.text = currency;
      fromCurrency.add(optionFrom);

      const optionTo = document.createElement("option");
      optionTo.value = allCurrencies[currency];
      optionTo.text = currency;
      toCurrency.add(optionTo);
    });

  loadSelected();
  updateConvertedValue();

  function getCurrencies(all, special) {
    const filtered = Object.keys(all)
            .filter(it => !special.includes(it))
            .sort();

    return [...special, ...filtered];
  }

  function updateConvertedValue() {
    const amountValue = amount.value;
    const fromOption = fromCurrency.selectedOptions[0];
    const toOption = toCurrency.selectedOptions[0];
    const value = (amountValue / (fromOption.value / toOption.value)).toFixed(2);
    converted.textContent = `${value} ${toOption.text}`;
  }

  function saveSelected() {
    const fromOption = fromCurrency.selectedOptions[0].text;
    const toOption = toCurrency.selectedOptions[0].text;
    try {
      localStorage.setItem("selected", JSON.stringify({
        fromOption,
        toOption
      }));
    } catch (e) {
      console.error(e);
    }
  }

  function loadSelected() {
    try {
      const item = localStorage.getItem("selected");
      if (item) {
        const settings = JSON.parse(item);
        setSelected(fromCurrency, settings.fromOption);
        setSelected(toCurrency, settings.toOption);
      }
    } catch (e) {
      console.error(e);
    }
  }

  function setSelected(select, option) {
    const candidateOption = [...select.options].find(it => it.text === option);

    if (candidateOption) {
      candidateOption.selected = true;
    }
  }

  amount.addEventListener("keyup", function () {
    updateConvertedValue();
  });

  amount.addEventListener("change", function () {
    updateConvertedValue();
  });

  toCurrency.addEventListener("change", function () {
    updateConvertedValue();
    saveSelected();
  });

  fromCurrency.addEventListener("change", function () {
    updateConvertedValue();
    saveSelected();
  });

  swapCurrencies.addEventListener("click", function () {
      const fromOption = fromCurrency.selectedOptions[0].text;
      const toOption = toCurrency.selectedOptions[0].text;

      setSelected(fromCurrency, toOption);
      setSelected(toCurrency, fromOption);
      updateConvertedValue();
      saveSelected();
  });
</script>

